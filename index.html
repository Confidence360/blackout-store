<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BLACKOUT - Product Selector</title>
  <link rel="apple-touch-icon" href="icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0f0f1a">
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: #0f0f1a;
      color: #ffffff;
      transition: background 0.3s, color 0.3s;
    }
    body.light-mode {
      background: #f4f4f4;
      color: #000000;
    }
    .container {
      display: flex;
      flex: 1;
    }
    .sidebar {
      background: #121a26;
      padding: 20px;
      width: 280px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .main {
      flex-grow: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    header img {
      width: 100px;
      border-radius: 50%;
    }
    header h1 {
      margin: 10px 0;
      font-size: 24px;
      color: #00baff;
    }
    .actions {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
    }
    .actions button {
      padding: 10px;
      border: none;
      border-radius: 8px;
      background: #00baff;
      color: white;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .actions button i {
      margin-right: 8px;
    }
    .total, #selected-names {
      margin-top: 20px;
      text-align: center;
    }
    .filters {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .filters input[type="text"],
    .filters input[type="number"] {
      padding: 8px;
      border-radius: 5px;
      border: none;
      font-size: 14px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 20px;
    }
    .product {
      background: #1a1a2e;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      transition: transform 0.2s;
    }
    .product:hover {
      transform: scale(1.02);
    }
    .product.selected {
      border: 2px solid #00baff;
    }
    .product img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 10px;
      transition: opacity 0.3s ease-in-out;
    }
    .product-description {
      font-size: 13px;
      color: #ccc;
      margin-bottom: 10px;
    }
    .quantity {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    .quantity button {
      background: #00baff;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #00baff;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }
    .toast.show {
      opacity: 1;
    }
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        flex-direction: row;
        justify-content: space-around;
        align-items: center;
      }
    }
  </style>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <header>
        <img src="images/logo.png" alt="Logo">
        <h1>BLACKOUT</h1>
      </header>
      <div class="actions">
        <button onclick="clearSelection()"><i class="fas fa-eraser"></i>Clear Selection</button>
        <button onclick="toggleTheme()"><i class="fas fa-adjust"></i>Toggle Theme</button>
      </div>
      <div class="total">Total: <span id="total-price">$0.00</span></div>
      <div id="selected-names">Selected: None</div>
    </div>
    <div class="main">
      <div class="filters">
        <input type="text" id="search" placeholder="Search products..." oninput="renderProducts()">
        <input type="number" id="minPrice" placeholder="Min price" oninput="renderProducts()">
        <input type="number" id="maxPrice" placeholder="Max price" oninput="renderProducts()">
      </div>
      <div class="grid" id="product-list"></div>
    </div>
  </div>
  <div id="toast" class="toast">Fallback to cached CSV data</div>
  <script>
    let products = [];
    const productList = document.getElementById('product-list');
    const totalPriceEl = document.getElementById('total-price');
    const selectedNamesEl = document.getElementById('selected-names');
    let selectedProducts = JSON.parse(localStorage.getItem('selectedProducts') || '[]');

    function preloadImages(imageUrls) {
      imageUrls.forEach(url => {
        const img = new Image();
        img.src = url;
      });
    }

    function applyInitialTheme() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const shouldUseLight = savedTheme === 'light' || (!savedTheme && !prefersDark);
      document.body.classList.toggle('light-mode', shouldUseLight);
    }

    function toggleTheme() {
      document.body.classList.toggle('light-mode');
      const isLight = document.body.classList.contains('light-mode');
      localStorage.setItem('theme', isLight ? 'light' : 'dark');
    }

    function renderProducts() {
      const searchValue = document.getElementById('search')?.value.toLowerCase() || '';
      const minPrice = parseFloat(document.getElementById('minPrice')?.value) || 0;
      const maxPrice = parseFloat(document.getElementById('maxPrice')?.value) || Infinity;

      productList.innerHTML = '';
      const imageUrls = [];

      products
        .filter(p => p.name.toLowerCase().includes(searchValue) && p.price >= minPrice && p.price <= maxPrice)
        .sort((a, b) => a.price - b.price)
        .forEach(product => {
          const div = document.createElement('div');
          div.className = 'product';
          if (selectedProducts.some(p => p.name === product.name)) div.classList.add('selected');

          const selectedItem = selectedProducts.find(p => p.name === product.name);
          const quantity = selectedItem?.quantity || 0;

          const imageUrl = `https://raw.githubusercontent.com/Confidence360/blackout-store/main/${product.image}`;
          imageUrls.push(imageUrl);

          const imgTag = document.createElement('img');
          imgTag.src = imageUrl;
          imgTag.alt = product.name;
          imgTag.loading = 'lazy';
          imgTag.onerror = function() {
            this.src = 'images/fallback.png';
          };

          div.appendChild(imgTag);
          div.innerHTML += `
            <div>${product.name}</div>
            <div class="product-description">${product.description || 'No description available.'}</div>
            <div class="price">$${product.price.toFixed(2)}</div>
            <div class="quantity">
              <button onclick="changeQuantity('${product.name}', -1)">-</button>
              <span>${quantity}</span>
              <button onclick="changeQuantity('${product.name}', 1)">+</button>
            </div>
          `;

          productList.appendChild(div);
        });

      preloadImages(imageUrls);
      updateSummary();
    }

    function changeQuantity(name, delta) {
      const index = selectedProducts.findIndex(p => p.name === name);
      if (index > -1) {
        selectedProducts[index].quantity += delta;
        if (selectedProducts[index].quantity < 1) {
          selectedProducts.splice(index, 1);
        }
      } else if (delta > 0) {
        const product = products.find(p => p.name === name);
        selectedProducts.push({ ...product, quantity: 1 });
      }
      saveSelection();
    }

    function clearSelection() {
      selectedProducts = [];
      saveSelection();
    }

    function saveSelection() {
      localStorage.setItem('selectedProducts', JSON.stringify(selectedProducts));
      renderProducts();
    }

    function updateSummary() {
      const total = selectedProducts.reduce((sum, p) => sum + parseFloat(p.price) * p.quantity, 0);
      const names = selectedProducts.map(p => `${p.name} (x${p.quantity})`).join(', ') || 'None';
      totalPriceEl.textContent = `$${total.toFixed(2)}`;
      selectedNamesEl.textContent = `Selected: ${names}`;
    }

    function parseCSV(text) {
      const lines = text.split('\n').filter(Boolean);
      const [header, ...rows] = lines;
      return rows.map(row => {
        const [name, price, image, description = `Description for ${name}`] = row.split(',').map(cell => cell.trim());
        return {
          name,
          price: parseFloat(price),
          image,
          description
        };
      });
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    async function loadCSVFromGitHub() {
      const CSV_URL = 'https://raw.githubusercontent.com/Confidence360/blackout-store/main/products.csv';
      try {
        const response = await fetch(CSV_URL);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const text = await response.text();
        localStorage.setItem('cachedCSV', text);
        products = parseCSV(text);
        renderProducts();
      } catch (error) {
        console.error('Failed to load CSV:', error);
        const cached = localStorage.getItem('cachedCSV');
        if (cached) {
          showToast('Using cached product data');
          products = parseCSV(cached);
          renderProducts();
        } else {
          productList.innerHTML = `<p style="color:red;">Failed to load product list. Please check your connection or try again later.</p>`;
        }
      }
    }

    applyInitialTheme();
    loadCSVFromGitHub();
  </script>
</body>
</html>
